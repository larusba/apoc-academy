<style type="text/css" media="screen">
/*
.nodes-image {
	margin:-100;
}
*/	
@import url("//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css");

.imageblock .content img, .image img {max-width: 900px;max-height: 300px;}
.deck h3, .deck h4 {display: block !important;margin-bottom:8px;margin-top:5px;}
.listingblock {margin:8px;}
.pull-bottom {position:relative;bottom:1em;}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.admonitionblock.note.speaker { display:none; }
</style>
<style type="text/css" media="screen">
/* #editor.maximize-editor .CodeMirror-code { font-size:24px; line-height:26px; } */
</style>
<article class="guide" ng-controller="AdLibDataController">
  <carousel class="deck container-fluid">
    <!--slide class="row-fluid">
      <div class="col-sm-3">
        <h3>Exercise 6</h3>
        <p class="lead">Information</p>
			<!dl>
				
				
				
				
				
			</dl>
		</div>
      <div class="col-sm-9">
        <figure>
          <img style="width:300px" src=""/>
        </figure>
      </div>
    </slide-->
    

   <h4>Exercise 6</h4>
   

<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6: Monitoring Running Queries (Preparations)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Before you begin this exercise, you must have this environment:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Have a database that has access to the APOC library.</p>
</li>
<li>
<p>If you have not populated the database yet, execute this Cypher code to populate the database:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="Cypher" lang="Cypher"><!--code class="Cypher language-Cypher"-->CALL apoc.schema.assert({},{},true);

MATCH (n) DETACH DELETE n;

CREATE CONSTRAINT UniqueMovieIDConstraint ON (m:Movie)
ASSERT m.id IS UNIQUE;

CREATE CONSTRAINT UniquePersonIDConstraint ON (p:Person)
ASSERT p.id IS UNIQUE;

LOAD CSV WITH HEADERS FROM
'https://data.neo4j.com/advanced-cypher/movies2.csv' AS row
WITH row.movieId as movieId,
     row.title as title,
     row.genres as genres,
     toInteger(row.releaseYear) as releaseYear,
     toFloat(row.avgVote) as avgVote,
     collect({id: row.personId, name:row.name, born: toInteger(row.birthYear), died: toInteger(row.deathYear),personType: row.personType, roles: split(coalesce(row.characters,""),':')}) as people
MERGE (m:Movie {id:movieId})
  ON CREATE SET m.title=title, m.avgVote=avgVote,
  m.releaseYear=releaseYear, m.genres=split(genres,":")
WITH *
UNWIND people as person
MERGE (p:Person {id: person.id})
  ON CREATE SET p.name = person.name, p.born = person.born, p.died = person.died
WITH  m, person, p
CALL apoc.do.when(person.personType = 'ACTOR',
"MERGE (p)-[:ACTED_IN {roles: person.roles}]-&gt;(m)
           ON CREATE SET p:Actor",
"MERGE (p)-[:DIRECTED]-&gt;(m)
    ON CREATE SET p:Director",
{m:m, p:p, person:person}) YIELD value AS value
RETURN count(*);  // cannot end query with APOC call

CREATE INDEX PersonNameIndex FOR (p:Person) ON (p.name);

CREATE INDEX MovieTitleIndex FOR (m:Movie) ON (m.title);

CREATE CONSTRAINT UniqueGenreNameConstraint ON (g:Genre) ASSERT g.name IS UNIQUE;
MATCH (m:Movie)
UNWIND m.genres as name
WITH DISTINCT name, m
MERGE (g:Genre {name:name})
WITH g, m
MERGE (g)&lt;-[:IS_GENRE]-(m);

CALL db.index.fulltext.createNodeIndex(
'MovieTitleMixedCase',['Movie'], ['title'])<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>This is what you will see in the left panel for the database:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/4.0-query-tuning-exercises/images/InitialDatabase.png" alt="InitialDatabase." width="300">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Up until now in this course, you have been using a single Neo4j Browser session. For this exercise, you will need a second Neo4j Browser window that is connected to the same database.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you have opened Neo4j Browser through <strong>Neo4j Desktop</strong> and your database is running locally, you can simply open a Web browser window and go to localhost:7474 to open a new Neo4j Browser session. You will be using this session for monitoring running queries.
You are now ready to start this exercise.</p>
</li>
<li>
<p>If you are using <strong>Neo4j Aura</strong>, simply open a new Neo4j Browser session to the same database.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You are now ready to start this exercise.</p>
</div>
	</div>
  </div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 7: Monitoring Running Queries(Overview)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>In this exercise, you gain some experience with monitoring and killing a long-running query.</p>
</div>
<div class="paragraph">
<p>Go to the next page to start this exercise.</p>
</div>
	</div>
  </div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 7.1: Monitor and kill a long-running query. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Here is a query that will run for a long time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"--><span class="k">MATCH</span><span class="w"> </span><span class="ss">(</span><span class="n">a</span><span class="ss">),</span> <span class="ss">(</span><span class="n">b</span><span class="ss">),</span> <span class="ss">(</span><span class="n">c</span><span class="ss">),</span> <span class="ss">(</span><span class="n">d</span><span class="ss">),</span> <span class="ss">(</span><span class="n">e</span><span class="ss">)</span> <span class="k">RETURN</span> <span class="nf">count</span><span class="ss">(</span><span class="nf">id</span><span class="ss">(</span><span class="n">a</span><span class="ss">))</span><!--/code--></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Execute this query in the Neo4j Browser session (main session) you have used throughout this training.</p>
</li>
<li>
<p>In the monitoring Neo4j Browser session you started in a different window, monitor the queries using the <code>:queries</code> command.</p>
</li>
<li>
<p>In the monitoring Neo4j Browser session, call the cypher procedure to kill the query.</p>
</li>
</ol>
</div>
	</div>
  </div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 7.1: Monitor and kill a long-running query. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Here is a query that will run for a long time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"--><span class="k">MATCH</span><span class="w"> </span><span class="ss">(</span><span class="n">a</span><span class="ss">),</span> <span class="ss">(</span><span class="n">b</span><span class="ss">),</span> <span class="ss">(</span><span class="n">c</span><span class="ss">),</span> <span class="ss">(</span><span class="n">d</span><span class="ss">),</span> <span class="ss">(</span><span class="n">e</span><span class="ss">)</span> <span class="k">RETURN</span> <span class="nf">count</span><span class="ss">(</span><span class="nf">id</span><span class="ss">(</span><span class="n">a</span><span class="ss">))</span><!--/code--></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Execute this query in the Neo4j Browser session (main session) you have used throughout this training.</p>
</li>
<li>
<p>In the monitoring Neo4j Browser session you started in a different window, monitor the queries using the <code>:queries</code> command.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is what you will see:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/4.0-query-tuning-exercises/images/EX7.1.png" alt="EX7.1" width="600">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>In the monitoring Neo4j Browser session, call the cypher procedure to kill the query.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"--><span class="k">CALL</span> <span class="n">dbms.listQueries</span><span class="ss">()</span> <span class="k">YIELD</span> <span class="n">query</span><span class="ss">,</span> <span class="n">queryId</span><span class="ss">,</span> <span class="n">elapsedTimeMillis</span>
<span class="k">WHERE</span> <span class="n">query</span> <span class="k">STARTS</span> <span class="k">WITH</span> <span class="s1">'MATCH'</span> <span class="ow">AND</span> <span class="n">elapsedTimeMillis</span> <span class="o">&gt;</span> <span class="mi">5000</span>
<span class="k">CALL</span> <span class="n">dbms.killQuery</span><span class="ss">(</span><span class="n">queryId</span><span class="ss">)</span> <span class="k">YIELD</span> <span class="n">queryId</span> <span class="k">as</span> <span class="n">qid</span><span class="ss">,</span> <span class="n">message</span>
<span class="k">RETURN</span> <span class="s2">"Query: "</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span>  <span class="n">qid</span> <span class="o">+</span><span class="s2">" "</span> <span class="o">+</span> <span class="n">message</span> <span class="k">as</span> <span class="n">result</span><!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The result of executing this code will be:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/4.0-query-tuning-exercises/images/EX7.1A.png" alt="EX7.1A" width="600">
</div>
</div>
<div class="paragraph">
<p>And again you will see the failure in your main Neo4j Browser session.</p>
</div>
	</div>
  </div>
</slide>


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 7: Monitoring Running Queries (Summary)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>In this exercise, gained experience monitoring a long-running query and killing it.</p>
</div>
<div class="paragraph">
<p><a play-topic='https://guides.neo4j.com/4.0-query-tuning-exercises/08.html'>Continue to Exercise 8</a></p>
</div>
	</div>
  </div>
</slide>
  </carousel>
</article>